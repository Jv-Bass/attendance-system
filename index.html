<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS Attendance System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --jarvis-cyan: #00f0ff;
            --jarvis-cyan-dim: #00a0b0;
            --jarvis-orange: #ff6b35;
            --jarvis-bg: #0a0e17;
            --jarvis-panel: #0f1729;
            --jarvis-border: #1a2a4a;
            --jarvis-glow: 0 0 20px rgba(0, 240, 255, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: var(--jarvis-bg);
            min-height: 100vh;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        @keyframes bootSequence {
            0% { opacity: 0; filter: blur(10px); }
            20% { opacity: 1; filter: blur(0); }
            80% { opacity: 1; filter: blur(0); }
            100% { opacity: 0; }
        }
        @keyframes scanLine {
            0% { top: 0%; }
            50% { top: 100%; }
            100% { top: 0%; }
        }
        @keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bootLoad { 0% { width: 0%; } 100% { width: 100%; } }
        #bootScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--jarvis-bg);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .boot-logo {
            width: 120px; height: 120px;
            border: 3px solid var(--jarvis-cyan);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            animation: bootSequence 2.5s ease forwards; position: relative;
        }
        .boot-logo::before {
            content: ''; position: absolute;
            width: 80%; height: 80%;
            border: 2px solid transparent;
            border-top-color: var(--jarvis-cyan);
            border-radius: 50%;
            animation: rotate 1s linear infinite;
        }
        .boot-logo svg { width: 60px; height: 60px; fill: var(--jarvis-cyan); }
        .boot-text {
            margin-top: 30px; font-size: 14px;
            color: var(--jarvis-cyan);
            letter-spacing: 4px;
            animation: pulse 1.5s ease-in-out infinite;
        }
        .boot-bar { width: 200px; height: 4px; background: var(--jarvis-border); border-radius: 2px; margin-top: 20px; overflow: hidden; }
        .boot-bar-fill { height: 100%; background: var(--jarvis-cyan); width: 0%; animation: bootLoad 2s ease forwards 0.5s; }
        #appContainer { display: none; min-height: 100vh; position: relative; }
        .hud-corner {
            position: fixed; width: 100px; height: 100px;
            border: 2px solid var(--jarvis-cyan);
            opacity: 0.5; pointer-events: none; z-index: 100;
        }
        .hud-corner.top-left { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .hud-corner.top-right { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .hud-corner.bottom-left { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .hud-corner.bottom-right { bottom: 20px; right: 20px; border-left: none; border-top: none; }
        .hud-line { position: fixed; background: var(--jarvis-cyan); opacity: 0.3; pointer-events: none; }
        .hud-line.horizontal { width: 100px; height: 1px; top: 50px; }
        .hud-line.horizontal.left { left: 50px; }
        .hud-line.horizontal.right { right: 50px; }
        .scan-line {
            position: fixed; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, transparent, var(--jarvis-cyan), transparent);
            animation: scanLine 4s ease-in-out infinite;
            opacity: 0.5; pointer-events: none; z-index: 99;
        }
        .jarvis-header {
            background: linear-gradient(180deg, var(--jarvis-panel) 0%, var(--jarvis-bg) 100%);
            border-bottom: 1px solid var(--jarvis-border);
            padding: 24px; text-align: center; position: relative;
        }
        .jarvis-header::before {
            content: ''; position: absolute; bottom: -1px; left: 50%;
            transform: translateX(-50%); width: 200px; height: 2px;
            background: var(--jarvis-cyan); box-shadow: var(--jarvis-glow);
        }
        .jarvis-logo { display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px; }
        .jarvis-logo svg { width: 32px; height: 32px; fill: var(--jarvis-cyan); }
        .jarvis-logo h1 { font-size: 24px; font-weight: 600; color: var(--jarvis-cyan); text-shadow: var(--jarvis-glow); letter-spacing: 2px; }
        .jarvis-header .subtitle { font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 3px; }
        .current-time-display { margin-top: 20px; font-size: 48px; font-family: 'Courier New', monospace; color: var(--jarvis-cyan); text-shadow: var(--jarvis-glow); letter-spacing: 4px; }
        .current-date { font-size: 14px; color: #64748b; margin-top: 4px; }
        .user-info-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 24px; background: var(--jarvis-panel); border-bottom: 1px solid var(--jarvis-border); }
        .user-greeting { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; background: var(--jarvis-cyan); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--jarvis-bg); font-weight: 700; font-size: 14px; }
        .user-name { font-size: 14px; color: #e0e0e0; }
        .user-role { font-size: 11px; color: var(--jarvis-cyan); text-transform: uppercase; letter-spacing: 1px; }
        .logout-btn { background: transparent; border: 1px solid var(--jarvis-border); color: #64748b; padding: 8px 16px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; }
        .logout-btn:hover { border-color: var(--jarvis-cyan); color: var(--jarvis-cyan); }
        .main-content { max-width: 500px; margin: 0 auto; padding: 24px; }
        .jarvis-card {
            background: var(--jarvis-panel); border: 1px solid var(--jarvis-border); border-radius: 12px; padding: 24px; margin-bottom: 20px; position: relative; overflow: hidden; animation: slideUp 0.5s ease forwards;
        }
        .jarvis-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--jarvis-cyan); box-shadow: var(--jarvis-glow); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; color: var(--jarvis-cyan); text-transform: uppercase; letter-spacing: 1px; }
        .card-icon { width: 40px; height: 40px; background: rgba(0, 240, 255, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .card-icon svg { width: 20px; height: 20px; fill: var(--jarvis-cyan); }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 12px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 14px 16px; background: var(--jarvis-bg); border: 1px solid var(--jarvis-border); border-radius: 8px; color: #e0e0e0; font-size: 16px; transition: all 0.3s ease; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--jarvis-cyan); box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1), var(--jarvis-glow); }
        .form-select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300f0ff' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 16px center; }
        .form-select option { background: var(--jarvis-bg); color: #e0e0e0; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cyan { background: transparent; border: 2px solid var(--jarvis-cyan); color: var(--jarvis-cyan); }
        .btn-cyan:hover:not(:disabled) { background: var(--jarvis-cyan); color: var(--jarvis-bg); box-shadow: var(--jarvis-glow); }
        .btn-orange { background: transparent; border: 2px solid var(--jarvis-orange); color: var(--jarvis-orange); }
        .btn-orange:hover:not(:disabled) { background: var(--jarvis-orange); color: var(--jarvis-bg); }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .status-list { max-height: 300px; overflow-y: auto; }
        .status-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--jarvis-border); }
        .status-item:last-child { border-bottom: none; }
        .status-name { font-size: 14px; color: #e0e0e0; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .status-badge.checked-in { background: rgba(0, 240, 255, 0.1); border: 1px solid var(--jarvis-cyan); color: var(--jarvis-cyan); }
        .status-badge.checked-out { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; }
        .message { padding: 14px; border-radius: 8px; margin-bottom: 20px; display: none; animation: slideUp 0.3s ease; font-size: 14px; font-weight: 500; }
        .message.show { display: block; }
        .message.success { background: rgba(0, 240, 255, 0.1); border: 1px solid var(--jarvis-cyan); color: var(--jarvis-cyan); }
        .message.error { background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444; color: #ef4444; }
        .message.info { background: rgba(102, 126, 234, 0.1); border: 1px solid #667eea; color: #667eea; }
        .links { text-align: center; padding-top: 20px; border-top: 1px solid var(--jarvis-border); }
        .links a { color: #64748b; text-decoration: none; font-size: 13px; margin: 0 10px; transition: color 0.3s ease; }
        .links a:hover { color: var(--jarvis-cyan); }
        .links a.register-link { color: var(--jarvis-cyan); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--jarvis-panel); border: 1px solid var(--jarvis-border); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.4s ease; position: relative; }
        .modal::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--jarvis-cyan); box-shadow: var(--jarvis-glow); }
        .modal-header { padding: 24px 24px 16px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; color: var(--jarvis-cyan); text-transform: uppercase; letter-spacing: 1px; }
        .modal-close { background: transparent; border: none; color: #64748b; font-size: 24px; cursor: pointer; transition: color 0.3s ease; }
        .modal-close:hover { color: var(--jarvis-cyan); }
        .modal-body { padding: 0 24px 24px; }
        .form-group-modal { margin-bottom: 20px; }
        .submit-modal-btn { width: 100%; padding: 16px; background: var(--jarvis-cyan); border: none; border-radius: 8px; color: var(--jarvis-bg); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 1px; margin-top: 12px; }
        .submit-modal-btn:hover { box-shadow: var(--jarvis-glow); }
        textarea.form-input, textarea.form-select { min-height: 100px; resize: vertical; }
        .employee-type-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .employee-type-option { background: var(--jarvis-bg); border: 2px solid var(--jarvis-border); border-radius: 12px; padding: 16px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
        .employee-type-option:hover { border-color: var(--jarvis-cyan-dim); }
        .employee-type-option.selected { border-color: var(--jarvis-cyan); background: rgba(0, 240, 255, 0.05); }
        .employee-type-option input { display: none; }
        .employee-type-option .icon { font-size: 28px; margin-bottom: 8px; }
        .employee-type-option .label { font-size: 14px; font-weight: 600; color: #e0e0e0; }
        .employee-type-option .desc { font-size: 11px; color: #64748b; margin-top: 4px; }
        .success-icon { text-align: center; padding: 40px 20px; }
        .success-icon .check { font-size: 64px; margin-bottom: 20px; }
        .success-icon h3 { font-size: 20px; color: var(--jarvis-cyan); margin-bottom: 8px; }
        .success-icon p { color: #64748b; }
        .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: rotate 0.8s linear infinite; margin-right: 8px; }
        @media (max-width: 500px) { .hud-corner, .hud-line { display: none; } .current-time-display { font-size: 36px; } }
    </style>
</head>
<body>
    <div id="bootScreen">
        <div class="boot-logo">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
        </div>
        <div class="boot-text">JARVIS SYSTEM</div>
        <div class="boot-bar"><div class="boot-bar-fill"></div></div>
    </div>

    <div id="appContainer">
        <div class="hud-corner top-left"></div>
        <div class="hud-corner top-right"></div>
        <div class="hud-corner bottom-left"></div>
        <div class="hud-corner bottom-right"></div>
        <div class="hud-line horizontal left"></div>
        <div class="hud-line horizontal right"></div>
        <div class="scan-line"></div>

        <div class="user-info-bar" id="userInfoBar" style="display: none;">
            <div class="user-greeting">
                <div class="user-avatar" id="userAvatar">?</div>
                <div>
                    <div class="user-name" id="userName">-</div>
                    <div class="user-role" id="userRole">-</div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
        </div>

        <div class="jarvis-header">
            <div class="jarvis-logo">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <h1>JARVIS</h1>
            </div>
            <div class="subtitle">Attendance System v2.0</div>
            <div class="current-time-display" id="currentTime">00:00:00</div>
            <div class="current-date" id="currentDate">Loading...</div>
        </div>

        <div class="main-content" id="loginSection">
            <div class="jarvis-card">
                <div class="card-header">
                    <div class="card-title">Authentication</div>
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg>
                    </div>
                </div>
                <div id="loginMessage" class="message"></div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-cyan" id="loginBtn">
                        <span id="loginBtnText">ACCESS SYSTEM</span>
                    </button>
                </form>
                <div class="links">
                    <a href="#" onclick="showRegisterModal(); return false;" class="register-link">New Employee? Register Here</a>
                </div>
            </div>
        </div>

        <div class="main-content" id="attendanceSection" style="display: none;">
            <div class="jarvis-card">
                <div class="card-header">
                    <div class="card-title">Check In / Out</div>
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                    </div>
                </div>
                <div id="attendanceMessage" class="message"></div>
                <form id="attendanceForm">
                    <div class="form-group">
                        <label class="form-label">Select Employee</label>
                        <select class="form-select" id="employeeName" required>
                            <option value="">Choose your name...</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-cyan" id="checkinBtn">CHECK IN</button>
                        <button type="button" class="btn btn-orange" id="checkoutBtn" onclick="handleCheckout()">CHECK OUT</button>
                    </div>
                </form>
            </div>

            <div class="jarvis-card">
                <div class="card-header">
                    <div class="card-title">Active Sessions</div>
                    <div class="card-icon">
                        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                    </div>
                </div>
                <div class="status-list" id="statusList">
                    <p style="color: #64748b; text-align: center; padding: 20px;">Loading...</p>
                </div>
            </div>

            <div class="links">
                <a href="admin.html" target="_blank" style="color: var(--jarvis-cyan);">Admin Dashboard ‚Üí</a>
            </div>
        </div>
    </div>

    <!-- EOD Modal -->
    <div class="modal-overlay" id="eodModal">
        <div class="modal">
            <div class="modal-header">
                <h2>EOD Report</h2>
                <button class="modal-close" onclick="closeEodModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eodForm">
                    <div class="form-group-modal">
                        <label class="form-label">What did you accomplish today?</label>
                        <textarea class="form-input" id="eodAccomplishments" required placeholder="List your accomplishments..."></textarea>
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label">Revisions completed</label>
                        <textarea class="form-input" id="eodRevisionsDone" required placeholder="List revisions completed..."></textarea>
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label">New videos edited</label>
                        <input type="number" class="form-input" id="eodNewVideosCount" required min="0" placeholder="0">
                    </div>
                    <button type="submit" class="submit-modal-btn">Submit & Check Out</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Client Modal -->
    <div class="modal-overlay" id="clientModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Client Reports</h2>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientForm">
                    <div id="clientBoxes"></div>
                    <button type="button" class="submit-modal-btn" style="background: transparent; border: 1px solid var(--jarvis-border); color: #64748b;" onclick="addClientBox()">+ Add Client</button>
                    <button type="submit" class="submit-modal-btn">Submit Reports & Check Out</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal-overlay" id="registerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>New Employee Registration</h2>
                <button class="modal-close" onclick="closeRegisterModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="registerForm">
                    <div class="form-group-modal">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-input" id="regName" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-input" id="regEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label">Password *</label>
                        <input type="password" class="form-input" id="regPassword" required placeholder="Min 6 characters" minlength="6">
                    </div>
                    <div class="form-group-modal">
                        <label class="form-label">Employee Type *</label>
                        <div class="employee-type-group">
                            <label class="employee-type-option" id="typeRegularOption">
                                <input type="radio" name="regType" value="regular" checked>
                                <div class="icon">üë®‚Äçüíª</div>
                                <div class="label">Regular</div>
                                <div class="desc">EOD Reports</div>
                            </label>
                            <label class="employee-type-option" id="typeManagerOption">
                                <input type="radio" name="regType" value="manager">
                                <div class="icon">üëî</div>
                                <div class="label">Manager</div>
                                <div class="desc">Client Reports</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group-modal" id="managerFields" style="display: none;">
                        <label class="form-label">Role/Title *</label>
                        <input type="text" class="form-input" id="regRole" placeholder="e.g., Business Manager">
                        <label class="form-label" style="margin-top: 12px;">Manager Password *</label>
                        <input type="password" class="form-input" id="managerPassword" placeholder="Enter manager password">
                    </div>
                    <button type="submit" class="submit-modal-btn" id="registerBtn">Register</button>
                </form>
                <div id="registerSuccess" style="display: none;">
                    <div class="success-icon">
                        <div class="check">‚úÖ</div>
                        <h3>Registration Successful!</h3>
                        <p>You can now log in with your credentials.</p>
                        <button class="submit-modal-btn" style="margin-top: 20px;" onclick="closeRegisterModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uwnnpvepyyutrxsnhzku.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3bm5wdmVweXl1dHJ4c25oemt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDk4NDMsImV4cCI6MjA4NjcyNTg0M30.qbf1dnPQ8srUc2EcwNHNz3HFz3v5_A7gKUS1ZWKV7vM';
        const MANAGER_PASSWORD = 'louie2024';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentAttendanceId = null;
        let clientCount = 0;
        let employees = [];
        let userSession = null;

        document.addEventListener('DOMContentLoaded', async function() {
            setTimeout(() => {
                document.getElementById('bootScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                checkSession();
            }, 2800);

            updateTime();
            setInterval(updateTime, 1000);

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('attendanceForm').addEventListener('submit', handleCheckin);
            document.getElementById('eodForm').addEventListener('submit', handleEodSubmit);
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);

            setupEmployeeTypeToggle();
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        async function checkSession() {
            const savedSession = localStorage.getItem('jarvis_session');
            if (savedSession) {
                userSession = JSON.parse(savedSession);
                const { data: { user }, error } = await supabaseClient.auth.getUser(userSession.access_token);
                if (!error && user) {
                    currentUser = user;
                    showAttendance();
                    return;
                }
            }
            showLogin();
        }

        function showLogin() {
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('attendanceSection').style.display = 'none';
            document.getElementById('userInfoBar').style.display = 'none';
        }

        function showAttendance() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('attendanceSection').style.display = 'block';
            document.getElementById('userInfoBar').style.display = 'flex';
            
            document.getElementById('userName').textContent = currentUser.user_metadata?.full_name || 'User';
            document.getElementById('userRole').textContent = currentUser.user_metadata?.employee_type || 'Employee';
            document.getElementById('userAvatar').textContent = (currentUser.user_metadata?.full_name || 'U').charAt(0).toUpperCase();
            
            loadEmployees();
            loadStatus();
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const btnText = document.getElementById('loginBtnText');
            
            btn.disabled = true;
            btnText.innerHTML = '<span class="loading"></span>AUTHENTICATING...';
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) throw error;
                
                userSession = data.session;
                localStorage.setItem('jarvis_session', JSON.stringify(data.session));
                currentUser = data.user;
                
                showMessage('loginMessage', 'success', 'Welcome back, ' + (data.user.user_metadata?.full_name || 'User') + '!');
                setTimeout(() => { showAttendance(); }, 1000);
            } catch (error) {
                showMessage('loginMessage', 'error', 'Login failed: ' + error.message);
                btn.disabled = false;
                btnText.textContent = 'ACCESS SYSTEM';
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            localStorage.removeItem('jarvis_session');
            currentUser = null;
            userSession = null;
            showLogin();
            showMessage('loginMessage', 'info', 'You have been logged out.');
        }

        async function loadEmployees() {
            try {
                const { data, error } = await supabaseClient.from('employees').select('*').order('name', { ascending: true });
                if (error) throw error;
                employees = data || [];
                populateEmployeeDropdown();
            } catch (error) {
                console.error('Error loading employees:', error);
                employees = [
                    { name: 'JV', type: 'owner' },
                    { name: 'Louie', type: 'manager' },
                    { name: 'Angelito', type: 'regular' },
                    { name: 'Adrian', type: 'regular' },
                    { name: 'Jeff', type: 'regular' },
                    { name: 'Josh', type: 'regular' },
                    { name: 'John', type: 'regular' }
                ];
                populateEmployeeDropdown();
            }
        }

        function populateEmployeeDropdown() {
            const select = document.getElementById('employeeName');
            select.innerHTML = '<option value="">Choose your name...</option>';
            employees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.name;
                option.textContent = emp.name;
                select.appendChild(option);
            });
        }

        async function loadStatus() {
            try {
                const { data, error } = await supabaseClient.from('attendance_records').select('*').is('check_out_time', null);
                if (error) throw error;
                renderStatus(data || []);
            } catch (error) {
                console.error('Error loading status:', error);
                renderStatus([]);
            }
        }

        function renderStatus(records) {
            const container = document.getElementById('statusList');
            if (records.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No active sessions</p>';
                return;
            }
            container.innerHTML = records.map(r => `
                <div class="status-item">
                    <span class="status-name">${r.name}</span>
                    <span class="status-badge checked-in">Checked In</span>
                </div>
            `).join('');
        }

        async function handleCheckin(e) {
            e.preventDefault();
            const name = document.getElementById('employeeName').value;
            if (!name) return;
            
            try {
                const now = new Date();
                const { data, error } = await supabaseClient.from('attendance_records').insert({
                    name: name,
                    check_in_time: now.toISOString(),
                    date: now.toISOString().split('T')[0]
                }).select().single();
                
                if (error) throw error;
                
                showMessage('attendanceMessage', 'success', 'Check-in successful! Time: ' + now.toLocaleTimeString());
                loadStatus();
            } catch (error) {
                showMessage('attendanceMessage', 'error', 'Check-in failed: ' + error.message);
            }
        }

        async function handleCheckout() {
            const name = document.getElementById('employeeName').value;
            if (!name) {
                showMessage('attendanceMessage', 'error', 'Please select your name first');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.from('attendance_records')
                    .select('*')
                    .eq('name', name)
                    .is('check_out_time', null)
                    .single();
                
                if (error) throw error;
                if (!data) {
                    showMessage('attendanceMessage', 'error', 'No active check-in found for ' + name);
                    return;
                }
                
                currentAttendanceId = data.id;
                const emp = employees.find(e => e.name === name);
                
                if (emp && emp.type === 'manager') {
                    openClientModal();
                } else {
                    openEodModal();
                }
            } catch (error) {
                showMessage('attendanceMessage', 'error', 'Error: ' + error.message);
            }
        }

        async function handleEodSubmit(e) {
            e.preventDefault();
            try {
                const now = new Date();
                const { error } = await supabaseClient.from('attendance_records').update({
                    check_out_time: now.toISOString()
                }).eq('id', currentAttendanceId);
                
                if (error) throw error;
                
                const { error: reportError } = await supabaseClient.from('eod_reports').insert({
                    attendance_id: currentAttendanceId,
                    name: document.getElementById('employeeName').value,
                    accomplishments: document.getElementById('eodAccomplishments').value,
                    revisions_done: document.getElementById('eodRevisionsDone').value,
                    new_videos_count: parseInt(document.getElementById('eodNewVideosCount').value),
                    report_date: now.toISOString().split('T')[0]
                });
                
                if (reportError) throw reportError;
                
                closeEodModal();
                showMessage('attendanceMessage', 'success', 'EOD Report submitted & checked out!');
                loadStatus();
                document.getElementById('eodForm').reset();
            } catch (error) {
                showMessage('attendanceMessage', 'error', 'Error: ' + error.message);
            }
        }

        async function handleClientSubmit(e) {
            e.preventDefault();
            try {
                const now = new Date();
                const { error } = await supabaseClient.from('attendance_records').update({
                    check_out_time: now.toISOString()
                }).eq('id', currentAttendanceId);
                
                if (error) throw error;
                
                const clientBoxes = document.querySelectorAll('.form-group-modal[id^="clientBox"]');
                const clientReports = [];
                
                clientBoxes.forEach(box => {
                    const clientSelect = box.querySelector('.client-select');
                    const nameInput = box.querySelector('.client-name-input');
                    const report = box.querySelector('.client-report');
                    
                    let clientName = clientSelect.value;
                    if (clientName === 'new') {
                        clientName = nameInput.value.trim();
                    }
                    
                    if (clientName && report.value.trim()) {
                        clientReports.push({
                            attendance_id: currentAttendanceId,
                            name: document.getElementById('employeeName').value,
                            client_name: clientName,
                            report: report.value.trim(),
                            report_date: now.toISOString().split('T')[0]
                        });
                    }
                });
                
                if (clientReports.length > 0) {
                    const { error: clientError } = await supabaseClient.from('client_reports').insert(clientReports);
                    if (clientError) throw clientError;
                }
                
                closeClientModal();
                showMessage('attendanceMessage', 'success', clientReports.length + ' client report(s) submitted & checked out!');
                loadStatus();
            } catch (error) {
                showMessage('attendanceMessage', 'error', 'Error: ' + error.message);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const type = document.querySelector('input[name="regType"]:checked').value;
            const role = document.getElementById('regRole').value;
            const managerPassword = document.getElementById('managerPassword').value;
            
            if (type === 'manager' && managerPassword !== MANAGER_PASSWORD) {
                alert('Invalid manager password!');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name,
                            employee_type: type,
                            role: role || 'Employee'
                        }
                    }
                });
                
                if (error) throw error;
                
                const { error: empError } = await supabaseClient.from('employees').insert({
                    id: data.user.id,
                    name: name,
                    email: email,
                    type: type,
                    role: role || 'Employee'
                });
                
                if (empError) console.error('Error saving to employees:', empError);
                
                document.getElementById('registerForm').style.display = 'none';
                document.getElementById('registerSuccess').style.display = 'block';
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        function setupEmployeeTypeToggle() {
            document.getElementById('typeRegularOption').addEventListener('click', function() {
                document.querySelector('input[name="regType"][value="regular"]').checked = true;
                this.classList.add('selected');
                document.getElementById('typeManagerOption').classList.remove('selected');
                document.getElementById('managerFields').style.display = 'none';
            });
            
            document.getElementById('typeManagerOption').addEventListener('click', function() {
                document.querySelector('input[name="regType"][value="manager"]').checked = true;
                this.classList.add('selected');
                document.getElementById('typeRegularOption').classList.remove('selected');
                document.getElementById('managerFields').style.display = 'block';
            });
            
            document.getElementById('typeRegularOption').classList.add('selected');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.add('show');
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registerSuccess').style.display = 'none';
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('show');
            document.getElementById('registerForm').reset();
        }

        function openEodModal() {
            document.getElementById('eodModal').classList.add('show');
        }

        function closeEodModal() {
            document.getElementById('eodModal').classList.remove('show');
            document.getElementById('eodForm').reset();
        }

        function openClientModal() {
            document.getElementById('clientModal').classList.add('show');
            document.getElementById('clientBoxes').innerHTML = '';
            clientCount = 0;
            addClientBox();
        }

        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('show');
            document.getElementById('clientBoxes').innerHTML = '';
        }

        function addClientBox() {
            clientCount++;
            const clientList = [
                'Podcast Principles', 'MarketU', 'Sandy', 'Chris Vasquez (Video CEO Clients)', 'Apex (Tyler)',
                'Mood Studios (Alex)', 'Jordan'
            ];
            
            let options = '';
            clientList.forEach((client, index) => {
                options += `<option value="${client}">${client}</option>`;
            });
            options += `<option value="new">+ Add New Client</option>`;
            
            const html = `
                <div class="form-group-modal" id="clientBox${clientCount}" style="background: var(--jarvis-bg); padding: 16px; border-radius: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <strong style="color: var(--jarvis-cyan);">Client #${clientCount}</strong>
                        ${clientCount > 1 ? `<button type="button" style="background: rgba(239,68,68,0.1); border: 1px solid #ef4444; color: #ef4444; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;" onclick="document.getElementById('clientBox${clientCount}').remove()">Remove</button>` : ''}
                    </div>
                    <div style="margin-bottom: 12px;">
                        <select class="form-input client-select" onchange="handleClientSelect(this)" style="width: 100%;">
                            <option value="">Select client...</option>
                            ${options}
                        </select>
                    </div>
                    <input type="text" class="client-name-input" placeholder="Client name" style="width: 100%; padding: 10px 14px; background: var(--jarvis-panel); border: 1px solid var(--jarvis-border); border-radius: 8px; margin-bottom: 12px; display: none;">
                    <textarea class="form-input client-report" placeholder="Report for this client..." style="width: 100%; padding: 10px 14px; background: var(--jarvis-panel); border: 1px solid var(--jarvis-border); border-radius: 8px; min-height: 80px; resize: vertical;"></textarea>
                </div>
            `;
            
            document.getElementById('clientBoxes').insertAdjacentHTML('beforeend', html);
        }

        function handleClientSelect(select) {
            const nameInput = select.parentElement.parentElement.querySelector('.client-name-input');
            if (select.value === 'new') {
                nameInput.style.display = 'block';
                nameInput.required = true;
            } else {
                nameInput.style.display = 'none';
                nameInput.required = false;
            }
        }

        function showMessage(elementId, type, text) {
            const el = document.getElementById(elementId);
            el.className = 'message show ' + type;
            el.textContent = text;
            setTimeout(() => { el.classList.remove('show'); }, 5000);
        }
    </script>
</body>
</html>