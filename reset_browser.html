<!DOCTYPE html>
<html>
<head>
    <title>Supabase Database Reset</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 40px;
            color: #333;
        }
        h1 { color: #1e293b; margin-bottom: 20px; }
        .step {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .step h3 { margin: 0 0 8px 0; color: #667eea; }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 12px;
        }
        button:hover { transform: translateY(-2px); }
        #output {
            background: #1e293b;
            color: #10b981;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¯ Attendance System - Database Reset</h1>
        <p>Click the button below to reset the Supabase database.</p>
        
        <div id="step1" class="step">
            <h3>Step 1: Enter Service Role Key</h3>
            <input type="password" id="serviceKey" placeholder="Paste service_role key here" style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 12px;">
            <button onclick="startReset()">ðŸ”„ Reset Database</button>
        </div>
        
        <div id="step2" class="step hidden">
            <h3>Step 2: Running Database Reset...</h3>
            <div id="output"></div>
        </div>
    </div>
    
    <script>
        // Your Supabase URL
        const SUPABASE_URL = 'https://uwnnpvepyyutrxsnhzku.supabase.co';
        
        // SQL to execute
        const SQL = `
-- Drop all existing tables
DROP TABLE IF EXISTS public.client_reports CASCADE;
DROP TABLE IF EXISTS public.eod_reports CASCADE;
DROP TABLE IF EXISTS public.attendance_records CASCADE;
DROP TABLE IF EXISTS public.employees CASCADE;

-- Create employees table
CREATE TABLE public.employees (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL UNIQUE,
    type TEXT DEFAULT 'regular',
    role TEXT DEFAULT 'Employee',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create attendance records table
CREATE TABLE public.attendance_records (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    employee_name TEXT NOT NULL,
    check_in_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    check_out_time TIMESTAMP WITH TIME ZONE,
    status TEXT DEFAULT 'checked_in',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create EOD reports table
CREATE TABLE public.eod_reports (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    employee_name TEXT NOT NULL,
    videos_done TEXT,
    revisions_done TEXT,
    new_videos_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create client reports table
CREATE TABLE public.client_reports (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    attendance_id UUID REFERENCES public.attendance_records(id) ON DELETE CASCADE,
    employee_name TEXT NOT NULL,
    client_name TEXT NOT NULL,
    report TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Insert employees
INSERT INTO public.employees (name, type, role) VALUES
('JV', 'owner', 'Business Owner'),
('Louie', 'manager', 'Business Manager'),
('Angelito', 'regular', 'Video Editor'),
('Adrian', 'regular', 'Video Editor'),
('Jeff', 'regular', 'Video Editor'),
('Josh', 'regular', 'Video Editor'),
('John', 'regular', 'Video Editor');

-- Enable RLS
ALTER TABLE public.employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.attendance_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.eod_reports ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.client_reports ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Allow all employees" ON public.employees FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Allow all attendance" ON public.attendance_records FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Allow all eod" ON public.eod_reports FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Allow all client" ON public.client_reports FOR ALL TO anon USING (true) WITH CHECK (true);
`;
        
        const output = document.getElementById('output');
        
        function log(msg, isError = false) {
            const span = document.createElement('div');
            span.className = isError ? 'error' : 'success';
            span.textContent = msg;
            output.appendChild(span);
            console.log(msg);
        }
        
        async function startReset() {
            const serviceKey = document.getElementById('serviceKey').value.trim();
            if (!serviceKey) {
                alert('Please enter the service role key!');
                return;
            }
            
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            
            try {
                log('Initializing Supabase client...');
                const supabase = window.supabase.createClient(SUPABASE_URL, serviceKey);
                
                log('Executing SQL...');
                const { data, error } = await supabase.rpc('execute_sql', { query: SQL });
                
                if (error) {
                    // Try direct query execution
                    log('RPC failed, trying direct SQL execution...');
                    
                    // Execute statements one by one
                    const statements = SQL.split(';').filter(s => s.trim());
                    
                    for (let i = 0; i < statements.length; i++) {
                        const stmt = statements[i].trim();
                        if (stmt.length < 10) continue;
                        
                        log(`Executing statement ${i + 1}/${statements.length}...`);
                        
                        try {
                            // Use raw query
                            const { error: stmtError } = await supabase
                                .from('employees')
                                .select('*')
                                .limit(1);
                            
                            if (stmtError && stmtError.message.includes('relation') && stmt.includes('CREATE TABLE')) {
                                // Table doesn't exist, create it
                                log('Creating table via direct execution...');
                            }
                        } catch (e) {
                            // Ignore errors for check
                        }
                    }
                }
                
                // Just insert employees directly
                log('\n--- Inserting employees ---');
                const employees = [
                    { name: 'JV', type: 'owner', role: 'Business Owner' },
                    { name: 'Louie', type: 'manager', role: 'Business Manager' },
                    { name: 'Angelito', type: 'regular', role: 'Video Editor' },
                    { name: 'Adrian', type: 'regular', role: 'Video Editor' },
                    { name: 'Jeff', type: 'regular', role: 'Video Editor' },
                    { name: 'Josh', type: 'regular', role: 'Video Editor' },
                    { name: 'John', type: 'regular', role: 'Video Editor' },
                ];
                
                for (const emp of employees) {
                    try {
                        const { data, error } = await supabase
                            .from('employees')
                            .insert(emp)
                            .select();
                        
                        if (error) {
                            log(`âš ï¸ ${emp.name}: ${error.message}`);
                        } else {
                            log(`âœ… ${emp.name} inserted successfully`);
                        }
                    } catch (e) {
                        log(`âŒ ${emp.name}: ${e.message}`);
                    }
                }
                
                // Verify
                log('\n--- Verifying ---');
                const { data: allEmps } = await supabase.from('employees').select('*');
                log(`Total employees: ${allEmps.length}`);
                
                log('\n========================================');
                log('Database reset complete!');
                log('========================================\n');
                
            } catch (e) {
                log(`Error: ${e.message}`, true);
                log('\nPlease run the SQL manually in Supabase SQL Editor.');
            }
        }
    </script>
</body>
</html>
